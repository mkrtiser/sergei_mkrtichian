<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Boblox ‚Äî –ü–µ—Å–æ—á–Ω–∏—Ü–∞ –Ω–∞ Python</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <style>
        html, body { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* canvas */
        #canvas { 
            width: 100%; 
            height: 100%; 
            touch-action: none; 
            outline: none;
            cursor: default;
        }

        /* === –®–∞–ø–∫–∞: –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∞—è, –≥–∏–±–∫–∞—è === */
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;             /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ –æ–∫–Ω–∞ */
            height: 64px;            /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏ */
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            background: rgba(20, 20, 25, 0.90);
            color: #fff;
            padding: 8px 14px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
            z-index: 1000;
            transition: opacity 0.25s ease;
            overflow: hidden;        /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–ø–∞–¥–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
            white-space: nowrap;     /* –¥–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π */
        }

        #ui.hidden {
            opacity: 0.3;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–µ–≤–∞ ‚Äî –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è, –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –ø—Ä–∏ –º–∞–ª–æ–π —à–∏—Ä–∏–Ω–µ */
        #ui h2 {
            margin: 0;
            color: #4da6ff;
            font-weight: 400;
            font-size: 16px;
            flex: 0 0 auto;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 240px;
        }

        /* –†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî –≥–∏–±–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç, –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ —à–∏—Ä–∏–Ω–µ.
           –í—ã—Å–æ—Ç–∞ —É–º–µ–Ω—å—à–µ–Ω–∞, –Ω–æ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –º–æ–∂–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å (resize –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω). */
        #editor { 
            height: 40px; 
            min-height: 36px;
            max-height: 200px;
            background: rgba(10, 10, 15, 0.95); 
            color: #7cfc00; 
            border: 1px solid #333; 
            border-radius: 8px;
            padding: 8px 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.2;
            resize: vertical;         /* –º–æ–∂–Ω–æ –≤—ã—Ç—è–Ω—É—Ç—å –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
            outline: none;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.45);
            flex: 1 1 auto;           /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—â–∏–π—Å—è —ç–ª–µ–º–µ–Ω—Ç */
            overflow: auto;
            white-space: pre;         /* —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ */
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è */
        button#runBtn { 
            margin: 0;
            padding: 10px 14px;
            font-size: 14px; 
            background: linear-gradient(135deg, #2288ff, #0066cc); 
            border: none; 
            color: white; 
            cursor: pointer; 
            border-radius: 8px;
            font-weight: 600;
            letter-spacing: 0.4px;
            transition: all 0.15s ease;
            flex: 0 0 auto;
            white-space: nowrap;
        }
        button#runBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 136, 255, 0.2);
        }
        button#runBtn:disabled { 
            background: #555; 
            cursor: not-allowed; 
            box-shadow: none;
        }

        /* –°—Ç–∞—Ç—É—Å ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å–ø—Ä–∞–≤–∞, –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è */
        #status {
            margin-left: 8px;
            font-size: 13px;
            color: #ffcc00;
            min-width: 160px;
            max-width: 360px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.28);
            border-radius: 6px;
            border-left: 3px solid #2288ff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ UI-—ç–ª–µ–º–µ–Ω—Ç—ã (–Ω–µ —à–∞–ø–∫–∞) */
        #connection { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 8px 15px; 
            background: rgba(20, 20, 25, 0.85); 
            color: #7cfc00; 
            border-radius: 20px; 
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1001;
        }
        #players {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(20, 20, 25, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 120px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1001;
        }
        .key-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        .key-hint.hidden {
            opacity: 0.3;
        }
        #camera-mode {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 12px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        #camera-mode.hidden {
            opacity: 0.3;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .crosshair.visible {
            opacity: 1;
        }
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1px;
        }
        .crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
            top: 0;
        }
        .crosshair::after {
            width: 20px;
            height: 2px;
            left: 0;
            top: 9px;
        }
        #play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            font-size: 24px;
            background: linear-gradient(135deg, #2288ff, #0066cc);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            z-index: 1002;
            box-shadow: 0 10px 30px rgba(34, 136, 255, 0.4);
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 1px;
        }
        #play-button:hover {
            background: linear-gradient(135deg, #3399ff, #0077dd);
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(34, 136, 255, 0.6);
        }
        #play-button.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(0.9);
        }
        #escape-notice {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 25px 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 1003;
            border: 2px solid #2288ff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            display: none;
            max-width: 400px;
        }
        #escape-notice h3 {
            margin: 0 0 15px 0;
            color: #4da6ff;
        }
        #escape-notice p {
            margin: 0 0 20px 0;
            line-height: 1.5;
        }
        #escape-notice button {
            margin: 10px;
            width: auto;
            display: inline-block;
            padding: 10px 25px;
        }
    </style>
</head>
<body>
<canvas id="canvas" tabindex="0"></canvas>

<!-- –ü—Ä–∏—Ü–µ–ª -->
<div class="crosshair"></div>

<!-- –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å" -->
<button id="play-button">üéÆ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ ESC -->
<div id="escape-notice">
    <h3>–ò–≥—Ä–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</h3>
    <p>–í—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã. –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:</p>
    <button onclick="enterGameMode()">‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É</button>
</div>

<!-- –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–∞—è —à–∞–ø–∫–∞ -->
<div id="ui">
    <h2>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∏—Ä–∞</h2>
    <textarea id="editor"># –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Python
# –°–æ–∑–¥–∞—ë–º –û–ì–†–û–ú–ù–´–ô –ø–æ–ª (—É–∂–µ —Å–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–µ—Ä–æ–º, –Ω–æ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
# create_box(position=(0, -5, 0), size=(200, 10, 200), color="darkgray")

# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ç–æ—Ä–æ–Ω–µ –æ—Ç –∏–≥—Ä–æ–∫–∞
create_box(position=(20, 10, 0), size=(5, 5, 5), color="red")
create_sphere(position=(0, 20, -20), radius=5, color="lime")
create_box(position=(-20, 15, 10), size=(8, 3, 8), color="orange")
create_box(position=(10, 30, 15), size=(4, 4, 4), color="blue")

# –ú–µ–Ω—è–µ–º —Å–æ–ª–Ω—Ü–µ
set_sun(direction=(-1, -3, -1), intensity=6.0, color=(1, 0.9, 0.8))</textarea>
    <button id="runBtn" onclick="runCode()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥</button>
    <div id="status">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ù–∞–∂–º–∏—Ç–µ "–ù–ê–ß–ê–¢–¨ –ò–ì–†–£"</div>
</div>

<div id="connection">‚óè –û–Ω–ª–∞–π–Ω</div>
<div id="players">üë• –ò–≥—Ä–æ–∫–æ–≤: 1</div>
<div id="camera-mode">–ö–∞–º–µ—Ä–∞: 1-–µ –ª–∏—Ü–æ (C –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)</div>
<div class="key-hint">WASD - –¥–≤–∏–∂–µ–Ω–∏–µ | –ü–†–û–ë–ï–õ - –ø—Ä—ã–∂–æ–∫ | C - –∫–∞–º–µ—Ä–∞ | ESC - –ø–∞—É–∑–∞</div>

<script>
    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    const canvas = document.getElementById("canvas");
    const engine = new BABYLON.Engine(canvas, true, {
        preserveDrawingBuffer: true,
        stencil: true
    });

    // –°–¥–µ–ª–∞–µ–º canvas —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—ã–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–¥—É–±–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
    canvas.tabIndex = 0;

    let scene, camera, playerId = null, playerMesh = null;
    const entities = new Map();
    let sunLight = null;
    let connectedPlayers = 1;
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã
    let cameraMode = "first";
    let cameraDistance = 5;
    let cameraHeight = 2;
    let cameraYaw = 0;
    let cameraPitch = 0;
    let mouseSensitivity = 0.003;
    let isPointerLocked = false;
    let isGameActive = false;
    
    // ==================== –°–û–ó–î–ê–ù–ò–ï –°–¶–ï–ù–´ ====================
    function createScene() {
        scene = new BABYLON.Scene(engine);
        scene.clearColor = new BABYLON.Color4(0.1, 0.15, 0.2, 1.0);
        
        // HDR –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        const hdrTexture = BABYLON.CubeTexture.CreateFromPrefilteredData(
            "https://assets.babylonjs.com/environments/environmentSpecular.env", scene);
        scene.environmentTexture = hdrTexture;
        scene.environmentIntensity = 0.8;
        
        // Skybox
        const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 1000 }, scene);
        const skyboxMat = new BABYLON.StandardMaterial("skyBox", scene);
        skyboxMat.backFaceCulling = false;
        skyboxMat.reflectionTexture = hdrTexture.clone();
        skyboxMat.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
        skyboxMat.diffuseColor = new BABYLON.Color3(0.2, 0.4, 0.8);
        skyboxMat.specularColor = new BABYLON.Color3(0, 0, 0);
        skybox.material = skyboxMat;
        
        // –°–æ–ª–Ω–µ—á–Ω—ã–π —Å–≤–µ—Ç
        sunLight = new BABYLON.DirectionalLight("sunLight", new BABYLON.Vector3(-1, -2, -1), scene);
        sunLight.intensity = 5.0;
        sunLight.diffuse = new BABYLON.Color3(1, 0.95, 0.9);
        sunLight.specular = new BABYLON.Color3(0.8, 0.8, 0.7);
        
        // –ó–∞–ø–æ–ª–Ω—è—é—â–∏–π —Å–≤–µ—Ç
        const fillLight = new BABYLON.HemisphericLight("fillLight", new BABYLON.Vector3(0, 1, 0), scene);
        fillLight.intensity = 0.5;
        fillLight.diffuse = new BABYLON.Color3(0.6, 0.7, 0.8);
        
        // –¢–µ–Ω–∏
        const shadowGenerator = new BABYLON.ShadowGenerator(1024, sunLight);
        shadowGenerator.useBlurExponentialShadowMap = true;
        shadowGenerator.blurScale = 2;
        shadowGenerator.blurBoxOffset = 2;
        shadowGenerator.darkness = 0.4;
        
        // –ö–∞–º–µ—Ä–∞
        camera = new BABYLON.UniversalCamera("cam", new BABYLON.Vector3(0, 0, 0), scene);
        camera.attachControl(canvas, false);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
        camera.speed = 0;
        camera.angularSensibility = 100000;
        camera.applyGravity = false;
        camera.checkCollisions = false;
        camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
        
        // Post-processing —ç—Ñ—Ñ–µ–∫—Ç—ã
        const pipeline = new BABYLON.DefaultRenderingPipeline("default", true, scene, [camera]);
        pipeline.imageProcessing.contrast = 1.2;
        pipeline.imageProcessing.exposure = 0.8;
        pipeline.imageProcessing.toneMappingEnabled = true;
        pipeline.imageProcessing.toneMappingType = BABYLON.ImageProcessingConfiguration.TONEMAPPING_ACES;
        
        return shadowGenerator;
    }
    
    const shadowGenerator = createScene();
    
    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–´–®–¨–Æ –ò –ö–ù–û–ü–ö–ê "–ò–ì–†–ê–¢–¨" ====================

    function normalizeAngle(a) {
      const twoPi = Math.PI * 2;
      a = (a + Math.PI) % twoPi;
      if (a < 0) a += twoPi;
      return a - Math.PI;
    }

    function setupPointerLock() {
        // –°–æ–±—ã—Ç–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —É–∫–∞–∑–∞—Ç–µ–ª—è
        document.addEventListener("pointerlockchange", () => {
            isPointerLocked = document.pointerLockElement === canvas;
            
            if (isPointerLocked) {
                // –ú—ã—à—å –∑–∞—Ö–≤–∞—á–µ–Ω–∞ - —Ä–µ–∂–∏–º –∏–≥—Ä—ã –∞–∫—Ç–∏–≤–µ–Ω
                enterGameMode();
            } else {
                // –ú—ã—à—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                exitGameMode();
            }
        });
        
        document.addEventListener("pointerlockerror", () => {
            console.log("Pointer lock error");
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ê –ò–ù–í–ï–†–°–ò–Ø + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è yaw
        document.addEventListener("mousemove", (e) => {
            if (!isPointerLocked || !isGameActive || !playerMesh) return;
            
            const movementX = e.movementX || e.mozMovementX || e.webkitMovementX || 0;
            const movementY = e.movementY || e.mozMovementY || e.webkitMovementY || 0;
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å: –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –≤–ø—Ä–∞–≤–æ = –∫–∞–º–µ—Ä–∞ –≤–ø—Ä–∞–≤–æ
            // –ü–æ–¥–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∫–∞–º–µ—Ä—ã, —á—Ç–æ–±—ã –ø–æ–≤–æ—Ä–æ—Ç—ã –±—ã–ª–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã
            if (cameraMode === "first") {
                cameraYaw += movementX * mouseSensitivity;
            } else {
                cameraYaw -= movementX * mouseSensitivity;
            }
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å: –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –≤–≤–µ—Ä—Ö = –∫–∞–º–µ—Ä–∞ –≤–≤–µ—Ä—Ö (–≤ 1-–º –ª–∏—Ü–µ)
            if (cameraMode === "first") {
                cameraPitch -= movementY * mouseSensitivity;
            } else {
                cameraPitch += movementY * mouseSensitivity;
            }
            
            cameraPitch = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, cameraPitch));
            cameraYaw = normalizeAngle(cameraYaw);
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å"
        document.getElementById("play-button").addEventListener("click", enterGameMode);
    }
    
    function enterGameMode() {
        canvas.requestPointerLock();
        isGameActive = true;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å"
        document.getElementById("play-button").classList.add("hidden");
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ ESC
        document.getElementById("escape-notice").style.display = "none";
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—Ü–µ–ª
        document.querySelector('.crosshair').classList.add('visible');
        
        // –ó–∞—Ç–µ–º–Ω—è–µ–º UI –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        document.getElementById('ui').classList.add('hidden');
        document.querySelector('.key-hint').classList.add('hidden');
        document.getElementById('camera-mode').classList.add('hidden');
        
        // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
        canvas.style.cursor = "none";
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById("status").textContent = "‚úÖ –ò–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. ESC - –ø–∞—É–∑–∞";
        
        // –§–æ–∫—É—Å –Ω–∞ canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–ª–∞–≤–∏—à
        canvas.focus();
    }
    
    function exitGameMode() {
        isGameActive = false;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å"
        document.getElementById("play-button").classList.remove("hidden");
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ ESC
        document.getElementById("escape-notice").style.display = "block";
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏—Ü–µ–ª
        document.querySelector('.crosshair').classList.remove('visible');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        document.getElementById('ui').classList.remove('hidden');
        document.querySelector('.key-hint').classList.remove('hidden');
        document.getElementById('camera-mode').classList.remove('hidden');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
        canvas.style.cursor = "default";
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        document.getElementById("status").textContent = "‚è∏ –ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ. –ù–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'";
    }
    
    function toggleCameraMode() {
        cameraMode = cameraMode === "first" ? "third" : "first";
        updateCameraModeDisplay();
        
        if (cameraMode === "first") {
            cameraDistance = 0.5;
        } else {
            cameraDistance = 5;
        }
    }
    
    function setupCameraControls() {
        // –ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤ 3-–º –ª–∏—Ü–µ
        canvas.addEventListener("wheel", (e) => {
            e.preventDefault();
            
            if (cameraMode === "third" && isGameActive) {
                cameraDistance -= e.deltaY * 0.05;
                cameraDistance = Math.max(2, Math.min(30, cameraDistance));
            }
        });
    }
    
    function updateCameraModeDisplay() {
        const modeDisplay = document.getElementById("camera-mode");
        modeDisplay.textContent = `–ö–∞–º–µ—Ä–∞: ${cameraMode === "first" ? "1-–µ –ª–∏—Ü–æ" : "3-–µ –ª–∏—Ü–æ"} (C –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)`;
    }
    
    function updateCamera() {
        if (!playerMesh) return;
        
        const playerPos = playerMesh.position;
        
        if (cameraMode === "first") {
            // 1-–µ –ª–∏—Ü–æ: –∫–∞–º–µ—Ä–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–ª–∞–∑ –∫—É–±–∏–∫–∞
            const eyeHeight = 1.6;
            const cameraPos = new BABYLON.Vector3(
                playerPos.x,
                playerPos.y + eyeHeight,
                playerPos.z
            );
            
            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞
            const lookDirection = new BABYLON.Vector3(
                Math.sin(cameraYaw) * Math.cos(cameraPitch),
                Math.sin(cameraPitch),
                Math.cos(cameraYaw) * Math.cos(cameraPitch)
            );
            
            camera.position = cameraPos;
            camera.setTarget(cameraPos.add(lookDirection));
            
            // –ü—Ä—è—á–µ–º —Å–≤–æ–µ–≥–æ –∫—É–±–∏–∫–∞ –≤ 1-–º –ª–∏—Ü–µ
            if (playerMesh) {
                playerMesh.isVisible = false;
            }
        } else {
            // 3-–µ –ª–∏—Ü–æ: –∫–∞–º–µ—Ä–∞ –ø–æ–∑–∞–¥–∏ –∏ —á—É—Ç—å –≤—ã—à–µ –∏–≥—Ä–æ–∫–∞
            const cosPitch = Math.cos(cameraPitch);
            const sinPitch = Math.sin(cameraPitch);
            const fx = Math.sin(cameraYaw) * cosPitch;
            const fz = Math.cos(cameraYaw) * cosPitch;

            // –°–º–µ—â–µ–Ω–∏–µ –∑–∞ —Å–ø–∏–Ω–æ–π:
            const offset = new BABYLON.Vector3(
                -fx * cameraDistance,                       // –º–∏–Ω—É—Å ‚Äî –¥–∞–ª—å—à–µ –∑–∞ —Å–ø–∏–Ω–æ–π –ø–æ X
                cameraHeight + cameraDistance * sinPitch,   // –≤—ã—Å–æ—Ç–∞ + –ø–æ–¥–Ω—è—Ç–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                -fz * cameraDistance                        // –º–∏–Ω—É—Å ‚Äî –¥–∞–ª—å—à–µ –∑–∞ —Å–ø–∏–Ω–æ–π –ø–æ Z
            );

            camera.position = playerPos.add(offset);
            camera.setTarget(playerPos.add(new BABYLON.Vector3(0, cameraHeight * 0.5, 0)));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–µ–≥–æ –∫—É–±–∏–∫–∞ –≤ 3-–º –ª–∏—Ü–µ
            if (playerMesh) {
                playerMesh.isVisible = true;
            }
        }
    }
    
    // ==================== –°–û–ó–î–ê–ù–ò–ï –û–ë–™–ï–ö–¢–û–í ====================
    function createEntity(ent) {
        let mesh = entities.get(ent.id);
        
        // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
        if (!mesh) {
            if (ent.cube || ent.is_player) {
                // –ö–£–ë–ò–ö –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                const size = ent.size || [1, 2, 1];
                mesh = BABYLON.MeshBuilder.CreateBox("ent" + ent.id, {
                    width: size[0],
                    height: size[1],
                    depth: size[2]
                }, scene);
                
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–µ–ª–∞–µ–º –¥—Ä—É–≥–æ–π —Ü–≤–µ—Ç
                if (ent.id !== playerId) {
                    const colors = ["blue", "lime", "orange", "purple", "cyan", "magenta", "yellow"];
                    const otherColor = colors[ent.id % colors.length];
                    ent.color = otherColor;
                }
            } else if (ent.radius) {
                // –°—Ñ–µ—Ä–∞
                mesh = BABYLON.MeshBuilder.CreateSphere("ent" + ent.id, {
                    diameter: ent.radius * 2,
                    segments: 16
                }, scene);
            } else {
                // –û–±—ã—á–Ω—ã–π –∫—É–±
                const size = ent.size || [2, 2, 2];
                mesh = BABYLON.MeshBuilder.CreateBox("ent" + ent.id, {
                    width: size[0],
                    height: size[1],
                    depth: size[2]
                }, scene);
            }
            
            entities.set(ent.id, mesh);
            
            // –ú–∞—Ç–µ—Ä–∏–∞–ª PBR
            const pbr = new BABYLON.PBRMaterial("pbr" + ent.id, scene);
            pbr.metallic = 0.4;
            pbr.roughness = 0.3;
            pbr.subSurface.isRefractionEnabled = false;
            
            // –¶–≤–µ—Ç–∞
            const colors = {
                red: new BABYLON.Color3(1, 0.2, 0.2),
                lime: new BABYLON.Color3(0.3, 1, 0.3),
                blue: new BABYLON.Color3(0.3, 0.5, 1),
                gray: new BABYLON.Color3(0.5, 0.5, 0.5),
                darkgray: new BABYLON.Color3(0.3, 0.3, 0.3),
                orange: new BABYLON.Color3(1, 0.6, 0.1),
                purple: new BABYLON.Color3(0.8, 0.3, 1),
                yellow: new BABYLON.Color3(1, 1, 0.3),
                cyan: new BABYLON.Color3(0.3, 1, 1),
                magenta: new BABYLON.Color3(1, 0.3, 1),
                brown: new BABYLON.Color3(0.6, 0.4, 0.2)
            };
            
            pbr.albedoColor = colors[ent.color] || new BABYLON.Color3(0.8, 0.8, 0.8);
            
            // –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ–ª–∞–µ–º —Ç–µ–º–Ω–µ–µ
            if (ent.static) {
                pbr.albedoColor.scaleToRef(0.7, pbr.albedoColor);
            }
            
            // –î–ª—è –ø–æ–ª–∞ –¥–µ–ª–∞–µ–º –º–µ–Ω–µ–µ –æ—Ç—Ä–∞–∂–∞—é—â–∏–º
            if (ent.id === 0) {
                pbr.metallic = 0.1;
                pbr.roughness = 0.8;
            }
            
            mesh.material = pbr;
            
            // –¢–µ–Ω–∏
            shadowGenerator.addShadowCaster(mesh);
            mesh.receiveShadows = true;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ –≤—Ä–∞—â–µ–Ω–∏–µ
        if (mesh) {
            mesh.position.set(ent.position[0], ent.position[1], ent.position[2]);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (ent.rotation && ent.rotation.length === 4) {
                if (!mesh.rotationQuaternion) {
                    mesh.rotationQuaternion = new BABYLON.Quaternion();
                }
                mesh.rotationQuaternion.set(ent.rotation[0], ent.rotation[1], ent.rotation[2], ent.rotation[3]);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            if (ent.id === playerId) {
                playerMesh = mesh;
                // –í 1-–º –ª–∏—Ü–µ —Å–∫—Ä—ã–≤–∞–µ–º —Å–≤–æ—é –º–æ–¥–µ–ª—å
                if (cameraMode === "first") {
                    mesh.isVisible = false;
                }
            }
        }
    }
    
    // ==================== WEB SOCKET ====================
    const ws = new WebSocket("ws://" + location.host + "/ws");
    
    ws.onopen = () => {
        document.getElementById("status").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ù–∞–∂–º–∏—Ç–µ '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£'";
        document.getElementById("connection").style.color = "#7cfc00";
    };
    
    ws.onclose = () => {
        document.getElementById("status").textContent = "‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞";
        document.getElementById("connection").style.color = "#ff5555";
        document.getElementById("connection").textContent = "‚óè –û—Ñ–ª–∞–π–Ω";
        exitGameMode();
    };
    
    ws.onerror = () => {
        document.getElementById("status").textContent = "‚ö† –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
    };
    
    ws.onmessage = (msg) => {
        try {
            const data = JSON.parse(msg.data);
            
            if (data.type === "init") {
                // –°–µ—Ä–≤–µ—Ä —Å–æ–æ–±—â–∏–ª –Ω–∞—à ID –∏–≥—Ä–æ–∫–∞
                playerId = data.player_id;
                console.log("–ú–æ–π playerId:", playerId);
                return;
            }
            
            if (data.type === "state") {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–ª–Ω—Ü–µ
                if (sunLight && data.sun) {
                    sunLight.direction = new BABYLON.Vector3(...data.sun.direction);
                    sunLight.intensity = data.sun.intensity;
                    sunLight.diffuse = new BABYLON.Color3(...data.sun.color);
                }
                
                // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
                const players = data.entities.filter(e => e.is_player).length;
                if (players !== connectedPlayers) {
                    connectedPlayers = players;
                    document.getElementById("players").textContent = `üë• –ò–≥—Ä–æ–∫–æ–≤: ${connectedPlayers}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã
                data.entities.forEach(ent => createEntity(ent));
                
                // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç
                const currentIds = data.entities.map(e => e.id);
                for (const [id, mesh] of entities.entries()) {
                    if (!currentIds.includes(id) && id !== 0 && id !== -1) {
                        mesh.dispose();
                        entities.delete(id);
                    }
                }
            } else if (data.type === "error") {
                document.getElementById("status").textContent = "‚ùå –û—à–∏–±–∫–∞: " + data.message;
                console.error("–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data.message);
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
        }
    };
    
    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–ê–í–ò–ê–¢–£–†–û–ô ====================
    const keys = {};
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º e.code (—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏—à–∞) —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ä–∞—Å–∫–ª–∞–¥–∫–∏
    const codeToKey = {
      KeyW: "w",
      KeyA: "a",
      KeyS: "s",
      KeyD: "d",
      Space: " "
    };

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    document.addEventListener("keydown", (e) => {
      const code = e.code;
      const mapped = codeToKey[code];
      if (mapped) {
        if (!keys[mapped]) {
          console.log("keydown mapped:", code, "->", mapped);
        }
        keys[mapped] = true;
        e.preventDefault();
        return;
      }
      // fallback –Ω–∞ e.key –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ / –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤
      const k = (e.key || "").toLowerCase();
      if (["w", "a", "s", "d", " "].includes(k)) {
        keys[k] = true;
        e.preventDefault();
      }
    });

    document.addEventListener("keyup", (e) => {
      const code = e.code;
      const mapped = codeToKey[code];
      if (mapped) {
        keys[mapped] = false;
        e.preventDefault();
        return;
      }
      const k = (e.key || "").toLowerCase();
      if (["w", "a", "s", "d", " "].includes(k)) {
        keys[k] = false;
        e.preventDefault();
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ C –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
    document.addEventListener("keydown", (e) => {
        if ((e.key === "c" || e.key === "C" || e.key === "—Å" || e.key === "–°") && isGameActive) {
            e.preventDefault();
            toggleCameraMode();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            if (isPointerLocked && isGameActive) {
                document.exitPointerLock();
            }
        }
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–≤–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—ã–µ 50–º—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–º–µ—Ä–µ
    setInterval(() => {
        if (ws.readyState === WebSocket.OPEN && isPointerLocked && isGameActive) {
            // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ pointer lock
            // (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ)
            console.log("sending keys:", keys, "isPointerLocked:", isPointerLocked, "isGameActive:", isGameActive);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –∫–ª–∞–≤–∏—à–∏ (–≤–∫–ª—é—á–∞—è Caps Lock –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è)
            ws.send(JSON.stringify({
                type: "input",
                w: !!keys["w"],
                s: !!keys["s"],
                a: !!keys["a"],
                d: !!keys["d"],
                space: !!keys[" "],
                camera_yaw: normalizeAngle(cameraYaw),
                camera_mode: cameraMode
            }));
        }
    }, 50);
    
    // ==================== –ó–ê–ü–£–°–ö –ö–û–î–ê ====================
    function runCode() {
        const btn = document.getElementById("runBtn");
        const status = document.getElementById("status");
        
        if (ws.readyState !== WebSocket.OPEN) {
            status.textContent = "‚ö† –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É";
            return;
        }
        
        const code = document.getElementById("editor").value.trim();
        if (!code) {
            status.textContent = "‚ö† –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥";
            return;
        }
        
        btn.disabled = true;
        btn.textContent = "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...";
        status.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...";
        
        ws.send(JSON.stringify({ type: "run_code", code }));
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = "‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥";
            status.textContent = "‚úÖ –ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω";
        }, 2000);
    }
    
    // ==================== –ó–ê–ì–†–£–ó–ö–ê ====================
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π –∏ –º—ã—à—å—é
    setupPointerLock();
    setupCameraControls();
    updateCameraModeDisplay();
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–∞–º–µ—Ä—ã
    engine.runRenderLoop(() => {
        updateCamera();
        scene.render();
    });
    
    // –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
    window.addEventListener("resize", () => {
        engine.resize();
    });
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
    console.log("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Boblox!");
    console.log("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£' –¥–ª—è –Ω–∞—á–∞–ª–∞.");
    console.log("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD + –º—ã—à—å, –ü–†–û–ë–ï–õ - –ø—Ä—ã–∂–æ–∫, C - –∫–∞–º–µ—Ä–∞, ESC - –ø–∞—É–∑–∞");
</script>
</body>
</html>
